@namespace DayLog.Components.Layout
@inherits LayoutComponentBase

@using DayLog.Components.Layout

@inject DayLog.Services.Interfaces.IAuthService AuthService
@inject NavigationManager Navigation

<div class="app-shell">
    <aside class="sidebar" role="navigation">
        <div class="sidebar-inner">
            <div class="brand">
                <img src="Images/daylog.png" alt="DayLog" />
            </div>
            <NavMenu />
        </div>
    </aside>

    <div class="content-area">
        <main class="main-container">
            @Body
        </main>
    </div>
    @if (showFab)
    {
        <NewEntryFab ReturnUrl="@Navigation.Uri" />
    }
</div>

@code {
    private bool _sidebarCollapsed;

    protected override async Task OnInitializedAsync()
    {
        // Only check auth if not already on /login
        if (!Navigation.Uri.EndsWith("/login", StringComparison.OrdinalIgnoreCase))
        {
            var loggedIn = await AuthService.IsLoggedInAsync();
            if (!loggedIn)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }
        }
    }

    private bool showFab = true;

    protected override void OnInitialized()
    {
        UpdateFabVisibility();
        Navigation.LocationChanged += HandleLocationChanged;
    }

    private void HandleLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateFabVisibility();
        StateHasChanged();
    }

    private void UpdateFabVisibility()
    {
        var relative = Navigation.ToBaseRelativePath(Navigation.Uri).Split('?').FirstOrDefault() ?? string.Empty;
        relative = relative.Trim('/');
        // Hide FAB on Edit-entry and login pages
        if (relative.StartsWith("Edit-entry", StringComparison.OrdinalIgnoreCase) ||
        relative.Equals("login", StringComparison.OrdinalIgnoreCase))
        {
            showFab = false;
        }
        else
        {
            showFab = true;
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= HandleLocationChanged;
    }

    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
        // Optionally, toggle a CSS class on the root element via JS interop
    }
}