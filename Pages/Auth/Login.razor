@page "/login"
@layout DayLog.Components.Layout.EmptyLayout
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject DayLog.Services.Interfaces.IAuthService AuthService
@inject NavigationManager Navigation

<div class="login-container">
    <div class="login-card">
        <div class="login-branding">
            <img src="Images/daylog.png" alt="DayLog Logo" class="login-logo" />
            <h2>LogIn</h2>
        </div>
        <EditForm EditContext="@editContext" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <div class="form-group">
                <label for="username">Username:</label>
                <InputText id="username" class="form-control" @bind-Value="loginModel.Username"
                    autocomplete="username" />
                <ValidationMessage For="@(() => loginModel.Username)" />
            </div>
            <div class="form-group password-group">
                <label for="password">Password:</label>
                <InputText id="password" class="form-control" @bind-Value="loginModel.Password"
                    type="@(showPassword ? "text" : "password")" autocomplete="current-password" />
                <ValidationMessage For="@(() => loginModel.Password)" />
                <div class="show-password">
                    <input type="checkbox" id="showPassword" @bind="showPassword" />
                    <label for="showPassword">Show Password</label>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }
            <button type="submit" class="login-btn" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner"></span>
                    <span>Logging in...</span>
                }
                else
                {
                    <span>Login</span>
                }
            </button>
        </EditForm>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private bool showPassword = false;
    private bool isLoading = false;
    private string? errorMessage;
    private EditContext? editContext;

    protected override void OnInitialized()
    {
        // Create EditContext for the form. Do not auto-validate on every field change
        // to avoid showing required-field errors while a user is still focusing inputs.
        editContext = new EditContext(loginModel);
    }

    private async Task HandleLogin()
    {
        errorMessage = null;
        isLoading = true;
        StateHasChanged();
        var success = await AuthService.LoginAsync(loginModel.Username, loginModel.Password);
        isLoading = false;
        if (success)
        {
            Navigation.NavigateTo("/dashboard", true);
        }
        else
        {
            errorMessage = "Invalid username or password.";
        }
    }

    public class LoginModel
    {
        [Required]
        public string Username { get; set; } = string.Empty;
        [Required]
        public string Password { get; set; } = string.Empty;
    }
}